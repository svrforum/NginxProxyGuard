# ModSecurity Configuration Override for nginx-proxy-guard
# Phase 0: Detection mode only (SecRuleEngine DetectionOnly)
# Phase 3: Will enable blocking mode (SecRuleEngine On)

# Detection mode - log but don't block
SecRuleEngine DetectionOnly

# Audit log settings
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABCDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsec/modsec_audit.log

# Debug log (disable in production)
SecDebugLog /var/log/modsec/modsec_debug.log
SecDebugLogLevel 0

# Request body handling
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# Response body handling
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

# Temp files
SecTmpDir /tmp/
SecDataDir /tmp/

# Rule settings
SecPcreMatchLimit 100000
SecPcreMatchLimitRecursion 100000

# Allowed HTTP methods (including WebDAV methods for compatibility)
# WebDAV methods: PROPFIND PROPPATCH MKCOL COPY MOVE LOCK UNLOCK
SecAction "id:900200,phase:1,nolog,pass,t:none,setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT PATCH DELETE PROPFIND PROPPATCH MKCOL COPY MOVE LOCK UNLOCK'"

# Paranoia level (1-4, higher = more strict)
SecAction "id:900000,phase:1,nolog,pass,t:none,setvar:tx.paranoia_level=1"

# Anomaly threshold
SecAction "id:900110,phase:1,nolog,pass,t:none,setvar:tx.inbound_anomaly_score_threshold=5,setvar:tx.outbound_anomaly_score_threshold=4"
