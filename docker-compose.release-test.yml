# Release Testing - Uses published Docker Hub images
# IMPORTANT: Uses isolated network and container names to avoid affecting production
# Usage: VERSION=1.2.5 docker compose -f docker-compose.release-test.yml up --abort-on-container-exit

name: npg-release-test

services:
  # PostgreSQL - Test instance
  db:
    image: postgres:15-alpine
    container_name: release-test-db
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
      POSTGRES_DB: nginx_proxy_guard_test
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - release-test-network

  # Valkey (Redis) - Test instance
  valkey:
    image: valkey/valkey:8-alpine
    container_name: release-test-valkey
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - release-test-network

  # API - Released image from Docker Hub
  api:
    image: svrforum/nginxproxyguard-api:${VERSION:-latest}
    container_name: release-test-api
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      PORT: "8080"
      DATABASE_URL: postgres://test_user:test_password@release-test-db:5432/nginx_proxy_guard_test?sslmode=disable
      REDIS_URL: redis://release-test-valkey:6379/0
      JWT_SECRET: test_jwt_secret_12345678901234567890123456789012
      ENVIRONMENT: test
      NGINX_CONTAINER: release-test-nginx
      NGINX_SKIP_TEST: "false"
    depends_on:
      db:
        condition: service_healthy
      valkey:
        condition: service_healthy
    volumes:
      - release_test_nginx_conf:/etc/nginx:rw
      - release_test_api_data:/app/data:rw
      - /var/run/docker.sock:/var/run/docker.sock:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 10s
    networks:
      - release-test-network

  # Nginx - Released image from Docker Hub
  nginx:
    image: svrforum/nginxproxyguard-nginx:${VERSION:-latest}
    container_name: release-test-nginx
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    volumes:
      - release_test_nginx_conf:/etc/nginx:rw
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - release-test-network

  # Dummy Upstream for connectivity tests
  whoami:
    image: traefik/whoami
    container_name: release-test-whoami
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - release-test-network

  # Dummy upstream 2 for multiple host tests
  httpbin:
    image: kennethreitz/httpbin
    container_name: release-test-httpbin
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - release-test-network

  # Test Runner - Runs integration tests
  # Use: docker compose -f docker-compose.release-test.yml run --rm test-runner
  test-runner:
    image: golang:1.23-alpine
    container_name: release-test-runner
    working_dir: /app
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    profiles:
      - test  # Only starts with --profile test or explicit 'run' command
    volumes:
      - ./api:/app:ro
    environment:
      API_BASE_URL: http://release-test-api:8080
      NGINX_URL: http://release-test-nginx:80
      DATABASE_URL: postgres://test_user:test_password@release-test-db:5432/nginx_proxy_guard_test?sslmode=disable
      CGO_ENABLED: "0"
    depends_on:
      db:
        condition: service_healthy
      api:
        condition: service_healthy
      nginx:
        condition: service_healthy
      whoami:
        condition: service_started
      httpbin:
        condition: service_started
    command: >
      sh -c "
        echo 'Waiting for services to stabilize...' &&
        sleep 5 &&
        echo 'Running integration tests...' &&
        go test -v -timeout 300s ./tests/integration/...
      "
    networks:
      - release-test-network

# Isolated network for testing - does not affect production
networks:
  release-test-network:
    name: npg-release-test-network
    driver: bridge

# Isolated volumes for testing - does not affect production
volumes:
  release_test_nginx_conf:
    name: npg_release_test_nginx_conf
  release_test_api_data:
    name: npg_release_test_api_data
