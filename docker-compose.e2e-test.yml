# E2E Test Environment - Isolated from production
# Builds from local source, uses separate ports/volumes/network
#
# Usage:
#   Start:   docker compose -f docker-compose.e2e-test.yml up -d --build
#   Test:    cd test/e2e && BASE_URL=https://localhost:18181 npx playwright test
#   Stop:    docker compose -f docker-compose.e2e-test.yml down -v
#   Cleanup: docker compose -f docker-compose.e2e-test.yml down -v --remove-orphans

name: npg-e2e-test

services:
  # PostgreSQL - Test instance (fresh DB each run)
  db:
    image: timescale/timescaledb:latest-pg17
    container_name: npg-test-db
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: nginx_guard_test
    command: postgres -c shared_preload_libraries=timescaledb -c timescaledb.telemetry_level=off
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - test-network

  # Valkey (Redis) - Test instance
  valkey:
    image: valkey/valkey:8-alpine
    container_name: npg-test-valkey
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    command: valkey-server --maxmemory 64mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - test-network

  # Go API Server (Local Build)
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: npg-test-api
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      PORT: "8080"
      DATABASE_URL: postgres://postgres:postgres@db:5432/nginx_guard_test?sslmode=disable
      REDIS_URL: redis://valkey:6379/0
      JWT_SECRET: e2e_test_jwt_secret_12345678901234567890123456789012
      ENVIRONMENT: test
      NGINX_CONTAINER: npg-test-proxy
      NGINX_SKIP_TEST: "false"
      NGINX_STATUS_URL: "http://host.docker.internal:18080/nginx_status"
      NGINX_HTTP_PORT: "18080"
      NGINX_HTTPS_PORT: "18443"
      API_HOST_PORT: "19080"
      API_HOST: "127.0.0.1:19080"
    ports:
      - "19080:8080"
    depends_on:
      db:
        condition: service_healthy
      valkey:
        condition: service_healthy
    volumes:
      - e2e_test_nginx_conf:/etc/nginx:rw
      - e2e_test_api_data:/app/data:rw
      - /var/run/docker.sock:/var/run/docker.sock:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 10s
    networks:
      - test-network

  # React UI (Local Build)
  ui:
    build:
      context: ./ui
      dockerfile: Dockerfile
    container_name: npg-test-ui
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    ports:
      - "18181:443"
    depends_on:
      api:
        condition: service_healthy
    networks:
      - test-network

  # Nginx Reverse Proxy (Local Build) - HOST NETWORK MODE
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: npg-test-proxy
    network_mode: host
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      NGINX_HTTP_PORT: "18080"
      NGINX_HTTPS_PORT: "18443"
    volumes:
      - e2e_test_nginx_conf:/etc/nginx:rw
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:18080/health"]
      interval: 5s
      timeout: 5s
      retries: 15

networks:
  test-network:
    name: npg-e2e-test-network
    driver: bridge

volumes:
  e2e_test_nginx_conf:
    name: npg_e2e_test_nginx_conf
  e2e_test_api_data:
    name: npg_e2e_test_api_data
